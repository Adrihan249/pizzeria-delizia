<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Panel de Administración</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding: 30px;
      }
      .form-section {
        background-color: #f9f9f9;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .delete-button {
        background-color: #dc3545;
        color: white;
      }
      .delete-button:hover {
        background-color: #bb2d3b;
      }
      img {
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">Panel de Administración</h1>

      <!-- Crear Usuario -->
      <div class="form-section">
        <h2>Crear Usuario</h2>
        <form method="POST">
          <div class="row g-2">
            <div class="col-md-3">
              <input type="text" name="username" class="form-control" placeholder="Usuario" required />
            </div>
            <div class="col-md-3">
              <input type="password" name="password" class="form-control" placeholder="Contraseña" required />
            </div>
            <div class="col-md-3">
              <select name="rol" class="form-select">
                <option value="admin">Admin</option>
                <option value="cliente">Cliente</option>
              </select>
            </div>
            <div class="col-md-3">
              <button type="submit" name="crear_usuario" class="btn btn-primary w-100">Crear Usuario</button>
            </div>
          </div>
        </form>
      </div>

      <!-- Lista de Usuarios -->
      <h2>Usuarios Registrados</h2>
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for usuario in usuarios %}
          <tr>
            <td>{{ usuario.id }}</td>
            <td>{{ usuario.username }}</td>
            <td>{{ usuario.rol }}</td>
            <td>
              <form method="POST" class="d-inline">
                <button class="btn delete-button btn-sm" type="submit" name="eliminar_usuario" value="{{ usuario.id }}" onclick="return confirm('¿Eliminar este usuario?');">Eliminar</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Crear Producto -->
      <div class="form-section">
        <h2>Crear Producto</h2>
        <form method="POST">
          <div class="row g-2">
            <div class="col-md-3">
              <input type="text" name="nombre" class="form-control" placeholder="Nombre" required />
            </div>
            <div class="col-md-3">
              <input type="text" name="descripcion" class="form-control" placeholder="Descripción" required />
            </div>
            <div class="col-md-2">
              <input type="number" step="0.01" name="precio" class="form-control" placeholder="Precio" required />
            </div>
            <div class="col-md-2">
              <input type="text" name="tipo" class="form-control" placeholder="Tipo" required />
            </div>
            <div class="col-md-2">
              <input type="text" name="imagen" class="form-control" placeholder="Imagen" required />
            </div>
            <div class="col-md-2">
              <button type="submit" name="crear_producto" class="btn btn-success w-100">Crear Producto</button>
            </div>
          </div>
        </form>
      </div>

      <!-- Lista de Productos -->
      <h2>Productos</h2>
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Precio</th>
            <th>Tipo</th>
            <th>Imagen</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for producto in productos %}
          <tr>
            <td>{{ producto.id }}</td>
            <td>{{ producto.nombre }}</td>
            <td>{{ producto.descripcion }}</td>
            <td>S/ {{ producto.precio }}</td>
            <td>{{ producto.tipo }}</td>
            <td>
              {% if producto.imagen %}
              <img src="{{ producto.imagen }}" alt="Imagen" width="80" />
              {% else %} Sin imagen {% endif %}
            </td>
            <td>
              <form method="POST" class="d-inline">
                <input type="hidden" name="eliminar_producto" value="{{ producto.id }}" />
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de eliminar este producto?')">Eliminar</button>
              </form>
              <button class="btn btn-secondary btn-sm" onclick="mostrarFormulario('{{ producto.id }}')">Editar</button>
              <div id="formulario_{{ producto.id }}" style="display: none; margin-top: 10px">
                <form method="POST" class="mt-2">
                  <input type="hidden" name="editar_producto" value="{{ producto.id }}" />
                  <input type="text" class="form-control mb-2" name="nombre_{{ producto.id }}" value="{{ producto.nombre }}" placeholder="Nombre" />
                  <input type="text" class="form-control mb-2" name="descripcion_{{ producto.id }}" value="{{ producto.descripcion }}" placeholder="Descripción" />
                  <input type="number" step="0.01" class="form-control mb-2" name="precio_{{ producto.id }}" value="{{ producto.precio }}" placeholder="Precio" />
                  <input type="text" class="form-control mb-2" name="tipo_{{ producto.id }}" value="{{ producto.tipo }}" placeholder="Tipo" />
                  <input type="text" class="form-control mb-2" name="imagen_{{ producto.id }}" value="{{ producto.imagen }}" placeholder="Imagen URL" />
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm">Actualizar</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelarEdicion('{{ producto.id }}')">Cancelar</button>
                  </div>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Lista de Pedidos -->
      <h2>Pedidos</h2>
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Dirección</th>
            <th>Productos</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for pedido in pedidos %}
          <tr>
            <td>{{ pedido.id }}</td>
            <td>{{ pedido.nombre_cliente }}</td>
            <td>{{ pedido.direccion }}</td>
            <td>
              <ul>
                {% for detalle in pedido.detalles %}
                <li>{{ detalle.producto.nombre }} ({{ detalle.cantidad }})</li>
                {% endfor %}
              </ul>
            </td>
            <td>{% if pedido.estado != 'cancelado' %} S/ {{ pedido.total }} {% else %} - {% endif %}</td>
            <td>{{ pedido.estado }}</td>
            <td>{{ pedido.fecha.strftime('%d/%m/%Y %H:%M:%S') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <a class="btn btn-outline-danger mt-4" href="{{ url_for('auth.logout') }}">Cerrar Sesión</a>
    </div>

    <script>
      function mostrarFormulario(id) {
        var formularios = document.querySelectorAll('div[id^="formulario_"]');
        formularios.forEach(f => f.style.display = 'none');
        document.getElementById('formulario_' + id).style.display = 'block';
      }

      function cancelarEdicion(id) {
        document.getElementById('formulario_' + id).style.display = 'none';
      }
    </script>
  </body>
</html>